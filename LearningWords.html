<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Levelled Chinese-English Matching Game</title>
<style>
/* ...existing styles, unchanged... */
</style>
</head>
<body>
<!-- ...existing HTML, unchanged... -->
<script>
const easyPool = [
  {en:"apple", zh:"ËòãÊûú"},{en:"banana", zh:"È¶ôËïâ"},{en:"dog", zh:"Áãó"},{en:"cat", zh:"Ë≤ì"},{en:"school", zh:"Â≠∏Ê†°"},
  {en:"teacher", zh:"ËÄÅÂ∏´"},{en:"book", zh:"Êõ∏"},{en:"boy", zh:"Áî∑Â≠©"},{en:"girl", zh:"Â•≥Â≠©"},{en:"mother", zh:"Â™ΩÂ™Ω"},
  {en:"father", zh:"Áà∏Áà∏"},{en:"cup", zh:"ÊùØ"},{en:"ball", zh:"ÁêÉ"},{en:"chair", zh:"Ê§Ö"},{en:"desk", zh:"Êõ∏Ê°å"},
  {en:"bus", zh:"Â∑¥Â£´"},{en:"car", zh:"Ê±ΩËªä"},{en:"milk", zh:"ÁâõÂ•∂"},{en:"eye", zh:"ÁúºÁùõ"},{en:"nose", zh:"Èºª"}
];
// Use the full 180-pair medAdvPool from previous messages for the real pool!
const medAdvPool = [
  {en:"apple", zh:"ËòãÊûú"},{en:"banana", zh:"È¶ôËïâ"}, /* ... 180 real pairs ... */ 
];

// === Audio Context re-use for mobile compliance ===
let audioCtx = null;
function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
}
function playSound() {
    // Called strictly inside tap/click events!
    try {
        const ctx = getAudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square";
        o.frequency.value = 1080;
        g.gain.setValueAtTime(0.14, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.085);
        o.connect(g).connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.09);
        o.onended = () => { o.disconnect(); g.disconnect(); };
    } catch(e){}
}
function playCelebrationSound() {
    // Called strictly inside tap/click events!
    try {
        const ctx = getAudioCtx();
        const freq = [523.25, 659.25, 784];
        freq.forEach((f, i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = "triangle";
            o.frequency.value = f;
            g.gain.setValueAtTime(0.12, ctx.currentTime + 0.01 * i);
            g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.36 + 0.1 * i);
            o.connect(g).connect(ctx.destination);
            o.start(ctx.currentTime + 0.01 * i);
            o.stop(ctx.currentTime + 0.38 + 0.1 * i);
            o.onended = () => { o.disconnect(); g.disconnect(); };
        });
    } catch(e){}
}

let level = "Easy";
let pairs = easyPool, bubbles=[], bubbleStatus=[];
let currentPair, score=0, targetScore=9, fileLoaded=false, mode="EC";
let status=document.getElementById('status'), question=document.getElementById('question'), bubbleRow=document.getElementById('bubbleRow');
let restartBtn=document.getElementById('restartBtn'), defaultBtn=document.getElementById('defaultBtn');
let scoreVal=document.getElementById('scoreVal'), targetInput=document.getElementById('targetInput'), targetVal=document.getElementById('targetVal'), person=document.getElementById('score-climber');

function setLevel(lvl) {
    level = lvl;
    if (level==="Easy") { targetScore=9; pairs=pickRandom(easyPool, 9);}
    else if (level==="Medium") { targetScore=20; pairs=pickRandom(medAdvPool, 20);}
    else { targetScore=25; pairs=pickRandom(medAdvPool, 25);}
    document.getElementById('targetInput').value=targetScore;
    setTargetScore(targetScore);
    startGame();
}
function getGridDims() {
    if (level==="Easy") return [3,3];
    if (level==="Medium") return [5,4];
    return [5,5];
}
function pickRandom(pool, count) {
    let arr=pool.slice(),out=[];
    while(out.length<count && arr.length) {
        let i=Math.floor(Math.random()*arr.length);
        out.push(arr[i]);
        arr.splice(i,1);
    }
    return out;
}
function showConfetti() {
    const colors=["#ea2121","#fecb3e","#55ca48","#268ae1","#9442e0","#ff7cce"],confetti=document.getElementById('confetti');confetti.innerHTML="";
    for(let i=0;i<36;i++){const c=document.createElement('div');c.className="confetti-piece";
        c.style.background=colors[Math.floor(Math.random()*colors.length)];
        c.style.left=(10+Math.random()*90)+"vw";c.style.top=(7+Math.random()*18)+"vh";
        c.style.transform=`rotate(${Math.random()*180}deg)`;confetti.appendChild(c);}
    setTimeout(()=>{confetti.innerHTML="";},1200);
}
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();reader.onload=function(e){
        const txt=e.target.result.trim();let loadedPairs=[];
        txt.split(/\r?\n/).forEach(line=>{
            let parts=line.split(',');if(parts.length===2){
                let en=capitalize(parts[0].trim()),zh=parts[1].trim();
                if(en&&zh)loadedPairs.push({en:en,zh:zh});}});
        let grid=getGridDims(),count=grid[0]*grid[1];
        if(loadedPairs.length>=count){pairs=pickRandom(loadedPairs,count);fileLoaded=true;startGame();}
        else{status.textContent="Please upload at least "+count+" valid pairs (English,‰∏≠Êñá).";fileLoaded=false;}};reader.readAsText(file,'utf-8');
});
function useDefaultPairs() { setLevel(level); }
function setMode(m) { mode = m; startGame(); }
function startGame() {
    status.textContent="";
    let grid=getGridDims(),count=grid[0]*grid[1];
    bubbles=pairs.slice(0,count);
    bubbleStatus=Array(count).fill(true);
    restartBtn.style.display='none';
    verticalScoreUpdate();
    nextQuestion();
}
function nextQuestion() {
    let remainingPairs=bubbles.map((p,idx)=>bubbleStatus[idx]?p:null).filter(Boolean);
    if(remainingPairs.length===0){question.textContent="";status.textContent="";restartBtn.style.display="inline-block";return;}
    currentPair=remainingPairs[Math.floor(Math.random()*remainingPairs.length)];
    if(mode==="EC"){question.textContent=capitalize(currentPair.en);}
    else{question.textContent=currentPair.zh;}
    populateBubbles();
}
function populateBubbles() {
    let grid=getGridDims();
    bubbleRow.innerHTML="";
    bubbleRow.style.gridTemplateColumns=`repeat(${grid[0]},98px)`;
    bubbleRow.style.gridTemplateRows=`repeat(${grid[1]},92px)`;
    for(let idx=0;idx<bubbles.length;idx++){
        let p=bubbles[idx],button=document.createElement('button');
        button.className="bubble";
        let x = Math.round((Math.random()-0.5)*6); // -3 to +3 px
        let y = Math.round((Math.random()-0.5)*6);
        button.style.position = "relative";
        button.style.left = x + "px";
        button.style.top = y + "px";
        if(!bubbleStatus[idx]){
            button.classList.add('disappear');button.disabled=true;button.textContent='';
        }else{
            button.textContent=(mode==="EC")?p.zh:capitalize(p.en);
            button.onclick=function(){
                // Synchronous sound: always first!
                playSound();
                // Then game logic
                checkAnswer(idx,button);
            }
        }
        bubbleRow.appendChild(button);
    }
}
function checkAnswer(idx,btn){
    let chosen=bubbles[idx],isMatch=false;
    if(mode==="EC"){isMatch=chosen.zh===currentPair.zh;}
    else{isMatch=capitalize(chosen.en)===capitalize(currentPair.en);}
    if(isMatch&&bubbleStatus[idx]){
        bubbleStatus[idx]=false;
        btn.classList.add("burst");
        setTimeout(function(){btn.classList.add("disappear");btn.classList.remove("burst");},400);
        score++;updateScore();verticalScoreUpdate();
        if(score>=targetScore){
            // Play celebration sound directly on tap if possible
            playCelebrationSound();
            setTimeout(function(){
                verticalScoreUpdate();showConfetti();
                setTimeout(function(){
                    alert("üéâ ÊÅ≠ÂñúÔºÅYou reached your target score of "+targetScore+"!");
                    score=0;updateScore();verticalScoreUpdate();
                    if(fileLoaded){startGame();}else{useDefaultPairs();}
                },1100);
            },420);
        }else{
            status.textContent=`‚úÖ Correct!`;
            setTimeout(nextQuestion,800);
        }
    }else{
        btn.style.background="#dc3545";setTimeout(()=>btn.style.background="#2176ff",500);
        status.textContent="‚ùå Not correct. Try again!";
    }
}
function updateScore(){scoreVal.textContent=score<10?"0"+score:score;}
function verticalScoreUpdate(){
    targetVal.textContent=targetScore;
    let ratio=Math.min(score/targetScore,1),startTop=305,endTop=25;
    let newTop=startTop-(startTop-endTop)*ratio;person.style.top=newTop+"px";
}
function restartGame(){score=0;updateScore();verticalScoreUpdate();
    if(fileLoaded){startGame();}else{useDefaultPairs();}
}
function setTargetScore(val){
    let v=parseInt(val);if(isNaN(v)||v<1)v=9;
    targetScore=v;targetInput.value=v;targetVal.textContent=v;verticalScoreUpdate();
    if(scoreVal.textContent>=targetScore){status.textContent="üéâ Target already reached!";}
}
function capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}
window.onload=function(){setLevel("Easy");};
</script>
</body>
</html>
