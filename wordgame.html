<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Levelled Chinese-English Matching Game</title>
<style>
body { background:#e6ecf5; color:#143366; font-family:"Segoe UI","Arial",sans-serif; margin:0;padding:0; }
.container { display:flex; min-height:100vh; }
.sidebar { background:#e0e8f3; min-width:160px; max-width:200px; padding:28px 6px 24px 6px; box-shadow:2px 0 12px #b3b3b3; display:flex;flex-direction:column;align-items:flex-start; }
.sidebar section { margin-bottom:18px;width:100%; }
.sidebar label { font-size:1.09em;margin-bottom:9px;display:block; }
#levelArea label, #modeArea label { margin-bottom:10px;display:block;}
#vertical-score-panel { display:flex;flex-direction:column;align-items:flex-start;width:140px;min-width:102px;padding:40px 0 0 0;margin-right:22px;position:relative;height:390px; }
#hill-svg{width:72px;height:390px;z-index:1;}
#hill-path-vertical{stroke:#11703c;stroke-width:7;fill:none;}
#score-climber{width:48px;height:48px;position:absolute;left:18px;top:305px;font-size:2.5em;z-index:3;transition:top 0.4s cubic-bezier(0.5,1.5,0.4,0.9);transform:scaleX(-1);}
#score-flag-vertical{position:absolute;left:18px;top:25px;width:40px;height:40px;font-size:2.1em;z-index:2;}
#vertical-score-label{position:absolute;left:72px;top:32px;font-size:2.3em;color:#184075;font-weight:900;background:#ffe066;border-radius:2em;padding:12px 34px;box-shadow:0 6px 22px #ffe06666, 0 1px 0 #184075;border:4px solid #25ab60;letter-spacing:.07em;text-shadow:2px 2px 16px #fff,0 2px 2px #ffe066a0;z-index:9;width:112px;text-align:center;font-family:'Roboto Mono','Consolas',monospace;box-sizing:border-box;}
.main{flex:1;display:flex;flex-direction:column;align-items:center;}
#question{font-size:3.6em;margin:6px 0 6px 0;color:#2176ff;font-weight:700;letter-spacing:.05em;text-shadow:0 3px 20px #bcd9fa;}
.bubble-row{display:grid;justify-content:center;margin-bottom:30px;}
.bubble{width:98px;height:92px;display:flex;align-items:center;justify-content:center;background:#2176ff;color:#fff;border-radius:50px;font-size:1.6em;font-weight:500;cursor:pointer;transition:background 0.15s,opacity 0.3s;box-shadow:0 3px 8px #b3c1de;opacity:1;visibility:visible;border:none;}
.bubble:focus{outline:3px solid #ffe066;}
.bubble.disappear{opacity:0;visibility:hidden;pointer-events:none;transition:opacity 0.3s,visibility 0s 0.3s;}
.bubble.burst{animation:bubbleBurst .42s forwards;background:#cce6ff;box-shadow:0 0 64px 28px #fff9;z-index:4;}
@keyframes bubbleBurst{0%{transform:scale(1);opacity:1;}60%{transform:scale(1.6);opacity:0.7;filter:blur(1px);}90%{transform:scale(2.2);opacity:0.3;filter:blur(2px);}100%{opacity:0;transform:scale(0.1);filter:blur(12px);}
}
#confetti{position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:999;}
.confetti-piece{position:absolute;width:14px;height:24px;border-radius:4px;opacity:0.8;animation:confettiDrop 1.1s cubic-bezier(.7,.7,0,1) forwards;}
@keyframes confettiDrop{0%{transform:translateY(0)rotateZ(0);}90%{opacity:1;}100%{transform:translateY(380px)rotateZ(220deg);opacity:0;}
}
#status{margin:5px 0 0 0;font-size:1.2em;min-height:30px;color:#b22222;}
#overlay{position:fixed;z-index:1001;top:0;left:0;width:100vw;height:100vh;background:rgba(230,236,245,0.93);display:flex;align-items:center;justify-content:center;}
#overlayContent{background:#fff;border-radius:17px;box-shadow:0 3px 32px #aaa;padding:30px 36px;max-width:410px;text-align:center;}
#overlayContent h2{color:#184075;font-size:1.52em;margin-top:0;}
#closeOverlay{margin-top:22px;border-radius:28px;padding:12px 26px;background:#2176ff;color:#fff;border:none;font-size:1.05em;cursor:pointer;}
@media(max-width:700px){.container{flex-direction:column;}.sidebar{min-width:unset;box-shadow:none;}
}
</style>
</head>
<body>
<div id="overlay">
    <div id="overlayContent">
        <h2>How to Play</h2>
        <p>
            Select a <strong>level</strong> and <strong>mode</strong>.<br>
            <strong>EC</strong>: English prompt, choose the matching ä¸­æ–‡ bubble.<br>
            <strong>CE</strong>: ä¸­æ–‡ prompt, choose the matching English bubble.<br>
            Get correct matches to reach the target score. Upload your own word list for custom practice!
        </p>
        <button id="closeOverlay" aria-label="Start Game">Start!</button>
    </div>
</div>
<div class="container">
    <div class="sidebar">
        <section>
            <label>Upload .txt file (English,Chinese per line):</label>
            <input type="file" id="fileInput" accept=".txt">
            <button onclick="useDefaultPairs()" id="defaultBtn">Use Default Terms</button>
        </section>
        <section id="levelArea">
            <label><input type="radio" name="level" id="levelEasy" checked onchange="setLevel('Easy')"> Easy</label>
            <label><input type="radio" name="level" id="levelMedium" onchange="setLevel('Medium')"> Medium</label>
            <label><input type="radio" name="level" id="levelAdvanced" onchange="setLevel('Advanced')"> Advanced</label>
        </section>
        <section id="modeArea">
            <label><input type="radio" name="mode" id="modeEC" checked onchange="setMode('EC')"> English prompt, Chinese bubbles</label>
            <label><input type="radio" name="mode" id="modeCE" onchange="setMode('CE')"> Chinese prompt, English bubbles</label>
        </section>
        <section>
            <label>Target Score:&nbsp;
            <input type="number" id="targetInput" min="1" max="100" value="9" onchange="setTargetScore(this.value)">
            </label>
        </section>
        <button onclick="restartGame()" style="margin-top:10px;display:none;" id="restartBtn">Restart</button>
    </div>
    <div id="vertical-score-panel">
        <svg id="hill-svg" viewBox="0 0 72 390"><path id="hill-path-vertical" d="M65,370 Q45,120 35,60 Q24,21 20,18"/></svg>
        <div id="score-flag-vertical">ğŸ</div>
        <div id="vertical-score-label"><span id="scoreVal">00</span> / <span id="targetVal">9</span></div>
        <div id="score-climber">ğŸ§—â€â™‚ï¸</div>
    </div>
    <div class="main">
        <div id="confetti"></div>
        <div id="question"></div>
        <div id="status"></div>
        <div class="bubble-row" id="bubbleRow"></div>
    </div>
</div>
<script>
const easyPool = [
  {en:"apple", zh:"è˜‹æœ"},{en:"banana", zh:"é¦™è•‰"},{en:"dog", zh:"ç‹—"},{en:"cat", zh:"è²“"},{en:"school", zh:"å­¸æ ¡"},
  {en:"teacher", zh:"è€å¸«"},{en:"book", zh:"æ›¸"},{en:"boy", zh:"ç”·å­©"},{en:"girl", zh:"å¥³å­©"},{en:"mother", zh:"åª½åª½"},
  {en:"father", zh:"çˆ¸çˆ¸"},{en:"cup", zh:"æ¯"},{en:"ball", zh:"çƒ"},{en:"chair", zh:"æ¤…"},{en:"desk", zh:"æ›¸æ¡Œ"},
  {en:"bus", zh:"å·´å£«"},{en:"car", zh:"æ±½è»Š"},{en:"milk", zh:"ç‰›å¥¶"},{en:"eye", zh:"çœ¼ç›"},{en:"nose", zh:"é¼»"}
];

const medAdvPool = [
  {en:"apple",zh:"è˜‹æœ"},{en:"banana",zh:"é¦™è•‰"},{en:"orange",zh:"æ©™"},{en:"grape",zh:"è‘¡è„"},{en:"pear",zh:"æ¢¨"},
  {en:"peach",zh:"æ¡ƒ"},{en:"plum",zh:"æ"},{en:"pineapple",zh:"è è˜¿"},{en:"watermelon",zh:"è¥¿ç“œ"},{en:"cherry",zh:"æ«»æ¡ƒ"},
  {en:"strawberry",zh:"å£«å¤šå•¤æ¢¨"},{en:"mango",zh:"èŠ’æœ"},{en:"lemon",zh:"æª¸æª¬"},{en:"kiwi",zh:"å¥‡ç•°æœ"},{en:"dragon fruit",zh:"ç«é¾æœ"},
  {en:"book",zh:"æ›¸"},{en:"pen",zh:"ç­†"},{en:"bag",zh:"æ›¸åŒ…"},{en:"desk",zh:"æ›¸æ¡Œ"},{en:"chair",zh:"æ¤…"},
  {en:"cup",zh:"æ¯"},{en:"plate",zh:"ç¢Ÿ"},{en:"clock",zh:"é˜"},{en:"ball",zh:"çƒ"},{en:"ruler",zh:"å°º"},
  {en:"table",zh:"æ¡Œ"},{en:"window",zh:"çª—"},{en:"door",zh:"é–€"},{en:"school",zh:"å­¸æ ¡"},{en:"classroom",zh:"èª²å®¤"},
  {en:"blackboard",zh:"é»‘æ¿"},{en:"teacher",zh:"è€å¸«"},{en:"student",zh:"å­¸ç”Ÿ"},{en:"boy",zh:"ç”·å­©"},{en:"girl",zh:"å¥³å­©"},
  {en:"mother",zh:"åª½åª½"},{en:"father",zh:"çˆ¸çˆ¸"},{en:"sister",zh:"å§Šå¦¹"},{en:"brother",zh:"å…„å¼Ÿ"},{en:"family",zh:"å®¶åº­"},
  {en:"bus",zh:"å·´å£«"},{en:"car",zh:"æ±½è»Š"},{en:"taxi",zh:"çš„å£«"},{en:"train",zh:"ç«è»Š"},{en:"tram",zh:"é›»è»Š"},
  {en:"subway",zh:"åœ°éµ"},{en:"bicycle",zh:"å–®è»Š"},{en:"airplane",zh:"é£›æ©Ÿ"},{en:"boat",zh:"èˆ¹"},{en:"helicopter",zh:"ç›´å‡æ©Ÿ"},
  {en:"milk",zh:"ç‰›å¥¶"},{en:"water",zh:"æ°´"},{en:"juice",zh:"æœæ±"},{en:"soup",zh:"æ¹¯"},{en:"rice",zh:"é£¯"},
  {en:"bread",zh:"éºµåŒ…"},{en:"cake",zh:"è›‹ç³•"},{en:"ice cream",zh:"é›ªç³•"},{en:"egg",zh:"è›‹"},{en:"noodles",zh:"éºµ"},
  {en:"meat",zh:"è‚‰"},{en:"chicken",zh:"é›"},{en:"fish",zh:"é­š"},{en:"beef",zh:"ç‰›è‚‰"},{en:"pork",zh:"è±¬è‚‰"},
  {en:"vegetable",zh:"è”¬èœ"},{en:"corn",zh:"ç²Ÿç±³"},{en:"carrot",zh:"ç´…è˜¿è””"},{en:"potato",zh:"è–¯ä»”"},{en:"tomato",zh:"ç•ªèŒ„"},
  {en:"onion",zh:"æ´‹è”¥"},{en:"lettuce",zh:"ç”Ÿèœ"},{en:"cucumber",zh:"é’ç“œ"},{en:"pumpkin",zh:"å—ç“œ"},{en:"mushroom",zh:"è˜‘è‡"},
  {en:"eye",zh:"çœ¼ç›"},{en:"nose",zh:"é¼»"},{en:"ear",zh:"è€³æœµ"},{en:"mouth",zh:"å˜´"},{en:"teeth",zh:"ç‰™é½’"},
  {en:"tongue",zh:"èˆŒé ­"},{en:"face",zh:"é¢"},{en:"hair",zh:"é ­é«®"},{en:"head",zh:"é ­"},{en:"neck",zh:"é ¸"},
  {en:"shoulder",zh:"è†Šé ­"},{en:"elbow",zh:"æ‰‹è¸­"},{en:"arm",zh:"æ‰‹è‡‚"},{en:"hand",zh:"æ‰‹"},{en:"finger",zh:"æ‰‹æŒ‡"},
  {en:"nail",zh:"æŒ‡ç”²"},{en:"leg",zh:"è…³"},{en:"knee",zh:"è†é ­"},{en:"foot",zh:"è…³æ¿"},{en:"toe",zh:"è…³è¶¾"},
  {en:"hospital",zh:"é†«é™¢"},{en:"doctor",zh:"é†«ç”Ÿ"},{en:"nurse",zh:"è­·å£«"},{en:"medicine",zh:"è—¥"},{en:"clinic",zh:"è¨ºæ‰€"},
  {en:"shopping mall",zh:"å•†å ´"},{en:"market",zh:"å¸‚å ´"},{en:"library",zh:"åœ–æ›¸é¤¨"},{en:"bank",zh:"éŠ€è¡Œ"},{en:"park",zh:"å…¬åœ’"},
  {en:"playground",zh:"éŠæ¨‚å ´"},{en:"swimming pool",zh:"æ¸¸æ³³æ± "},{en:"restaurant",zh:"é¤å»³"},{en:"toilet",zh:"æ´—æ‰‹é–“"},{en:"post office",zh:"éƒµå±€"},
  {en:"cinema",zh:"é›»å½±é™¢"},{en:"police station",zh:"è­¦ç½²"},{en:"fire station",zh:"æ¶ˆé˜²å±€"},{en:"zoo",zh:"å‹•ç‰©åœ’"},{en:"museum",zh:"åšç‰©é¤¨"},
  {en:"bed",zh:"åºŠ"},{en:"sofa",zh:"æ¢³åŒ–"},{en:"TV",zh:"é›»è¦–"},{en:"lamp",zh:"ç‡ˆ"},{en:"fan",zh:"é¢¨æ‰‡"},
  {en:"air conditioner",zh:"å†·æ°£æ©Ÿ"},{en:"fridge",zh:"é›ªæ«ƒ"},{en:"microwave",zh:"å¾®æ³¢çˆ"},{en:"oven",zh:"ç„—çˆ"},{en:"computer",zh:"é›»è…¦"},
  {en:"phone",zh:"é›»è©±"},{en:"tablet",zh:"å¹³æ¿é›»è…¦"},{en:"camera",zh:"ç›¸æ©Ÿ"},{en:"printer",zh:"æ‰“å°æ©Ÿ"},{en:"mouse",zh:"æ»‘é¼ "},
  {en:"keyboard",zh:"éµç›¤"},{en:"bottle",zh:"æ¨½"},{en:"glass",zh:"ç»ç’ƒæ¯"},{en:"knife",zh:"åˆ€"},{en:"fork",zh:"å‰"},
  {en:"spoon",zh:"åŒ™"},{en:"chopsticks",zh:"ç­·å­"},{en:"napkin",zh:"é¤å·¾"},{en:"toothbrush",zh:"ç‰™åˆ·"},{en:"toothpaste",zh:"ç‰™è†"},
  {en:"soap",zh:"é¦™çš‚"},{en:"towel",zh:"æ¯›å·¾"},{en:"shampoo",zh:"æ´—é ­æ°´"},{en:"comb",zh:"æ¢³"},{en:"mirror",zh:"é¡"},
  {en:"eggplant",zh:"èŒ„å­"},{en:"broccoli",zh:"è¥¿è˜­èŠ±"},{en:"beans",zh:"è±†"},{en:"ginger",zh:"è–‘"},{en:"garlic",zh:"è’œé ­"},
  {en:"lettuce",zh:"ç”Ÿèœ"},{en:"pea",zh:"é’è±†"},{en:"celery",zh:"èŠ¹èœ"},{en:"radish",zh:"ç™½è˜¿è””"},{en:"turnip",zh:"å¤§é ­èœ"},
  {en:"uncle",zh:"å”å”"},{en:"aunt",zh:"å§¨å§¨"},{en:"cousin",zh:"è¡¨å…„å¼Ÿå§Šå¦¹"},{en:"grandfather",zh:"ç¥–çˆ¶"},{en:"grandmother",zh:"ç¥–æ¯"},
  {en:"baby",zh:"å¬°å…’"},{en:"friend",zh:"æœ‹å‹"},{en:"neighbor",zh:"é„°å±…"},{en:"boss",zh:"è€é—†"},{en:"teacher",zh:"è€å¸«"},
  {en:"student",zh:"å­¸ç”Ÿ"},{en:"classmate",zh:"åŒå­¸"},{en:"principal",zh:"æ ¡é•·"},{en:"clerk",zh:"è·å“¡"},{en:"driver",zh:"å¸æ©Ÿ"},
  {en:"policeman",zh:"è­¦å¯Ÿ"},{en:"fireman",zh:"æ¶ˆé˜²å“¡"},{en:"mailman",zh:"éƒµå·®"},{en:"waiter",zh:"ä¾æ‡‰"},{en:"cook",zh:"å»šå¸«"},
  {en:"artist",zh:"è—è¡“å®¶"},{en:"singer",zh:"æ­Œæ‰‹"},{en:"actor",zh:"æ¼”å“¡"},{en:"nurse",zh:"è­·å£«"},{en:"doctor",zh:"é†«ç”Ÿ"},
  {en:"dentist",zh:"ç‰™é†«"},{en:"gardener",zh:"åœ’ä¸"},{en:"janitor",zh:"æ¸…æ½”å·¥"},{en:"engineer",zh:"å·¥ç¨‹å¸«"},{en:"farmer",zh:"è¾²å¤«"},
  {en:"worker",zh:"å·¥äºº"},{en:"boss",zh:"è€é—†"},{en:"pilot",zh:"æ©Ÿå¸«"},{en:"coach",zh:"æ•™ç·´"},{en:"swimmer",zh:"æ¸¸æ³³é¸æ‰‹"},
  {en:"runner",zh:"è³½è·‘è€…"},{en:"dancer",zh:"èˆè¹ˆå“¡"},{en:"soccer player",zh:"è¶³çƒå“¡"},{en:"basketball player",zh:"ç±ƒçƒå“¡"},{en:"sailor",zh:"æ°´æ‰‹"}
];
let level = "Easy";
let pairs = easyPool, bubbles=[], bubbleStatus=[];
let currentPair, score=0, targetScore=9, fileLoaded=false, mode="EC";
let status=document.getElementById('status'), question=document.getElementById('question'), bubbleRow=document.getElementById('bubbleRow');
let restartBtn=document.getElementById('restartBtn'), defaultBtn=document.getElementById('defaultBtn');
let scoreVal=document.getElementById('scoreVal'), targetInput=document.getElementById('targetInput'), targetVal=document.getElementById('targetVal'), person=document.getElementById('score-climber');

function setLevel(lvl) {
    level = lvl;
    if (level==="Easy") { targetScore=9; pairs=pickRandom(easyPool, 9);}
    else if (level==="Medium") { targetScore=20; pairs=pickRandom(medAdvPool, 20);}
    else { targetScore=25; pairs=pickRandom(medAdvPool, 25);}
    document.getElementById('targetInput').value=targetScore;
    setTargetScore(targetScore);
    startGame();
}
function getGridDims() {
    if (level==="Easy") return [3,3];
    if (level==="Medium") return [5,4];
    return [5,5];
}
function pickRandom(pool, count) {
    let arr=pool.slice(),out=[];
    while(out.length<count && arr.length) {
        let i=Math.floor(Math.random()*arr.length);
        out.push(arr[i]);
        arr.splice(i,1);
    }
    return out;
}
function playSound() {
    try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator(),g=ctx.createGain();
        o.type="square";o.frequency.value=1080;g.gain.setValueAtTime(0.14,ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.00001,ctx.currentTime+0.085);o.connect(g).connect(ctx.destination);
        o.start();o.stop(ctx.currentTime+0.09);o.onended=()=>ctx.close();}
    catch(e){}
}
function playCelebrationSound() {
    try{const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const freq=[523.25,659.25,784];
    freq.forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();
        o.type="triangle";o.frequency.value=f;
        g.gain.setValueAtTime(0.12,ctx.currentTime+0.01*i);
        g.gain.exponentialRampToValueAtTime(0.00001,ctx.currentTime+0.36+0.1*i);
        o.connect(g).connect(ctx.destination);o.start(ctx.currentTime+0.01*i);
        o.stop(ctx.currentTime+0.38+0.1*i);o.onended=()=>ctx.close();});
    }catch(e){}
}
function showConfetti() {
    const colors=["#ea2121","#fecb3e","#55ca48","#268ae1","#9442e0","#ff7cce"],confetti=document.getElementById('confetti');confetti.innerHTML="";
    for(let i=0;i<36;i++){const c=document.createElement('div');c.className="confetti-piece";
        c.style.background=colors[Math.floor(Math.random()*colors.length)];
        c.style.left=(10+Math.random()*90)+"vw";c.style.top=(7+Math.random()*18)+"vh";
        c.style.transform=`rotate(${Math.random()*180}deg)`;confetti.appendChild(c);}
    setTimeout(()=>{confetti.innerHTML="";},1200);
}
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();reader.onload=function(e){
        const txt=e.target.result.trim();let loadedPairs=[];
        txt.split(/\r?\n/).forEach(line=>{
            let parts=line.split(/[,;\t]/); // Supports comma, semicolon, tab
            if(parts.length===2){
                let en=parts[0].trim(),zh=parts[1].trim();
                if(en&&zh)loadedPairs.push({en:en,zh:zh});}});
        let grid=getGridDims(),count=grid[0]*grid[1];
        if(loadedPairs.length>=count){pairs=pickRandom(loadedPairs,count);fileLoaded=true;startGame();}
        else{status.textContent="Please upload at least "+count+" valid pairs (English,ä¸­æ–‡).";fileLoaded=false;}
    };reader.readAsText(file,'utf-8');
});
function useDefaultPairs() { setLevel(level); }
function setMode(m) { mode = m; startGame(); }
function startGame() {
    status.textContent="";
    let grid=getGridDims(),count=grid[0]*grid[1];
    bubbles=pairs.slice(0,count);
    bubbleStatus=Array(count).fill(true);
    restartBtn.style.display='none';
    verticalScoreUpdate();
    nextQuestion();
}
function nextQuestion() {
    let remainingPairs=bubbles.map((p,idx)=>bubbleStatus[idx]?p:null).filter(Boolean);
    if(remainingPairs.length===0){question.textContent="";status.textContent="";restartBtn.style.display="inline-block";return;}
    currentPair=remainingPairs[Math.floor(Math.random()*remainingPairs.length)];
    if(mode==="EC"){question.textContent=capitalize(currentPair.en);}
    else{question.textContent=currentPair.zh;}
    populateBubbles();
}
function populateBubbles() {
    let grid=getGridDims();
    bubbleRow.innerHTML="";
    bubbleRow.style.gridTemplateColumns=`repeat(${grid[0]},98px)`;
    bubbleRow.style.gridTemplateRows=`repeat(${grid[1]},92px)`;
    for(let idx=0;idx<bubbles.length;idx++){
        let p=bubbles[idx],button=document.createElement('button');
        button.className="bubble";
        button.setAttribute('role','button');
        button.setAttribute('aria-pressed',bubbleStatus[idx]);
        // Gentle jitter
        let x = Math.round((Math.random()-0.5)*6); // -3 to +3 px
        let y = Math.round((Math.random()-0.5)*6);
        button.style.position = "relative";
        button.style.left = x + "px";
        button.style.top = y + "px";
        if(!bubbleStatus[idx]){
            button.classList.add('disappear');button.disabled=true;button.textContent='';
        }else{
            button.textContent=(mode==="EC")?p.zh:capitalize(p.en);
            button.tabIndex=0;
            button.onclick=function(){checkAnswer(idx,button);}
            button.onkeydown=function(ev){
                if((ev.key==="Enter"||ev.key===" ")&&bubbleStatus[idx]){checkAnswer(idx,button);}
            };
        }
        bubbleRow.appendChild(button);
    }
}
function checkAnswer(idx,btn){
    let chosen=bubbles[idx],isMatch=false;
    // Normalize for comparison
    if(mode==="EC"){
      isMatch=trim(chosen.zh)===trim(currentPair.zh);
    }else{
      isMatch=trim(chosen.en).toLowerCase()===trim(currentPair.en).toLowerCase();
    }
    if(isMatch&&bubbleStatus[idx]){
        bubbleStatus[idx]=false;btn.classList.add("burst");playSound();
        setTimeout(function(){btn.classList.add("disappear");btn.classList.remove("burst");},400);
        score++;updateScore();verticalScoreUpdate();
        if(score>=targetScore){
            setTimeout(function(){verticalScoreUpdate();showConfetti();playCelebrationSound();
                setTimeout(function(){
                    alert("ğŸ‰ æ­å–œï¼You reached your target score of "+targetScore+"!");
                    score=0;updateScore();verticalScoreUpdate();
                    if(fileLoaded){startGame();}else{useDefaultPairs();}
                },1100);
            },420);
        }else{status.textContent=`âœ… Correct!`;setTimeout(nextQuestion,800);}
    }else{
        btn.style.background="#dc3545";setTimeout(()=>btn.style.background="#2176ff",500);
        status.textContent="âŒ Not correct. Try again!";
    }
}
function updateScore(){scoreVal.textContent=score<10?"0"+score:score;}
function verticalScoreUpdate(){
    targetVal.textContent=targetScore;
    let ratio=Math.min(score/targetScore,1),startTop=305,endTop=25;
    let newTop=startTop-(startTop-endTop)*ratio;person.style.top=newTop+"px";
}
function restartGame(){score=0;updateScore();verticalScoreUpdate();
    if(fileLoaded){startGame();}else{useDefaultPairs();}
}
function setTargetScore(val){
    let v=parseInt(val);if(isNaN(v)||v<1)v=9;
    targetScore=v;targetInput.value=v;targetVal.textContent=v;verticalScoreUpdate();
    if(scoreVal.textContent>=targetScore){status.textContent="ğŸ‰ Target already reached!";}
}
function capitalize(str){if(!str)return "";return str.charAt(0).toUpperCase()+str.slice(1);}
function trim(str){return (str || "").replace(/^\s+|\s+$/g, "");}
window.onload=function(){
    setLevel("Easy");
    document.getElementById('closeOverlay').onclick=function(){
        document.getElementById('overlay').style.display="none";
    };
};
</script>
</body>
</html>
